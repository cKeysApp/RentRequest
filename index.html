<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>cKeys | Home</title>

  <style>
    :root{
      --bg:#f5f7fa;
      --card:#ffffff;
      --text:#111;
      --muted:#666;
      --border:#e6e9ef;
      --shadow: 0 10px 30px rgba(0,0,0,.08);
      --green:#28a745;
      --green2:#218838;
    }

    *{ box-sizing:border-box; }
    body{
      margin:0;
      font-family: Arial, sans-serif;
      background: var(--bg);
      color: var(--text);
      padding: 0;
    }

    /* ===== Top bar ===== */
    .topbar{
      display:flex;
      align-items:center;
      gap:10px;
      padding:14px 16px;
      position: sticky;
      top:0;
      background: rgba(245,247,250,.92);
      backdrop-filter: blur(10px);
      border-bottom: 1px solid var(--border);
      z-index: 10;
    }
    .hamburger{
      width:42px; height:42px;
      border-radius:10px;
      border:1px solid var(--border);
      background:#fff;
      display:grid;
      place-items:center;
      cursor:pointer;
      box-shadow: 0 6px 16px rgba(0,0,0,.05);
    }
    .hamburger span{
      display:block;
      width:18px; height:2px;
      background:#222;
      position:relative;
    }
    .hamburger span::before,
    .hamburger span::after{
      content:"";
      position:absolute;
      left:0;
      width:18px; height:2px;
      background:#222;
    }
    .hamburger span::before{ top:-6px; }
    .hamburger span::after{ top:6px; }

    .logo{
      display:flex;
      align-items:center;
      gap:10px;
      font-weight:800;
      letter-spacing:.2px;
    }
    .logo-badge{
      width:34px; height:34px;
      border-radius:10px;
      background:#111;
      color:#fff;
      display:grid;
      place-items:center;
      font-size:14px;
    }
    .logo small{
      display:block;
      font-weight:600;
      color: var(--muted);
      margin-top:2px;
      letter-spacing:0;
    }

    /* ===== Menu drawer ===== */
    .drawer{
      position:fixed;
      top:0; left:0;
      width: 280px;
      height: 100%;
      background:#fff;
      box-shadow: var(--shadow);
      border-right:1px solid var(--border);
      transform: translateX(-110%);
      transition: transform .25s ease;
      z-index: 20;
      padding: 16px;
    }
    .drawer.open{ transform: translateX(0); }
    .drawer h3{ margin: 10px 0 6px; }
    .drawer a{
      display:block;
      padding:10px 10px;
      border-radius:10px;
      color:#111;
      text-decoration:none;
      margin:6px 0;
      border:1px solid var(--border);
    }
    .drawer a:hover{ background: var(--bg); }
    .backdrop{
      position:fixed;
      inset:0;
      background: rgba(0,0,0,.35);
      opacity:0;
      pointer-events:none;
      transition: opacity .2s ease;
      z-index: 15;
    }
    .backdrop.show{
      opacity:1;
      pointer-events:auto;
    }
    
    .card-actions{
      display:flex;
      gap:10px;
      margin-top:10px;
    }
    .card-actions .btn{
      min-width:auto;
      flex:1;
      padding:10px 12px;
      border-radius:10px;
    }
    .btn.small{
      padding:10px 12px;
      font-size:13px;
    }
    .btn.disabled{
      opacity:.6;
      cursor:not-allowed;
    }

    /* ===== Main hero ===== */
    .wrap{
      max-width: 980px;
      margin: 0 auto;
      padding: 26px 16px 40px;
    }
    .hero{
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 16px;
      box-shadow: var(--shadow);
      padding: 26px 18px;
      text-align:center;
    }
    .hero h1{
      margin:0;
      font-size: 28px;
    }
    .hero p{
      margin:10px auto 18px;
      max-width: 520px;
      color: var(--muted);
      line-height:1.4;
    }
    .actions{
      display:flex;
      gap:12px;
      justify-content:center;
      flex-wrap:wrap;
    }
    .btn{
      padding: 12px 18px;
      border-radius: 12px;
      border: 1px solid var(--border);
      cursor:pointer;
      font-weight:700;
      font-size: 14px;
      background:#fff;
      box-shadow: 0 6px 16px rgba(0,0,0,.05);
      min-width: 140px;
    }
    .btn.primary{
      background: var(--green);
      border-color: var(--green);
      color:#fff;
    }
    .btn.primary:hover{ background: var(--green2); }
    .btn:hover{ background: var(--bg); }

    /* ===== Benefits ===== */
    .section-title{
      text-align:center;
      margin: 22px 0 10px;
      font-size: 18px;
      font-weight: 800;
      color:#222;
    }
    .benefits{
      margin-top: 14px;
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 14px;
    }
    .panel{
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 16px;
      box-shadow: 0 6px 18px rgba(0,0,0,.05);
    }
    .panel h3{
      margin: 0 0 8px;
      font-size: 16px;
    }
    .panel ul{
      margin:0;
      padding-left: 18px;
      color: #333;
      line-height: 1.6;
    }

    /* ===== Modal ===== */
    .modal{
      position:fixed;
      inset:0;
      display:none;
      align-items:center;
      justify-content:center;
      z-index: 30;
      padding: 16px;
    }
    .modal.show{ display:flex; }
    .modal .overlay{
      position:absolute;
      inset:0;
      background: rgba(0,0,0,.45);
    }
    .modal .box{
      position:relative;
      width: min(620px, 100%);
      background:#fff;
      border-radius: 16px;
      border:1px solid var(--border);
      box-shadow: var(--shadow);
      padding: 16px;
      max-height: 88vh;
      overflow:auto;
    }
    .modal .box header{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 10px;
      margin-bottom: 10px;
    }
    .modal .box header h2{
      margin:0;
      font-size: 18px;
    }
    .close{
      border:1px solid var(--border);
      background:#fff;
      border-radius: 10px;
      padding: 8px 10px;
      cursor:pointer;
      font-weight:800;
    }

    /* ===== Form styles ===== */
    label{ font-size: 14px; font-weight: bold; }
    input, select{
      width:100%;
      padding: 12px;
      margin-top: 6px;
      margin-bottom: 14px;
      border: 1px solid #ccc;
      border-radius: 6px;
      font-size: 14px;
      box-sizing: border-box;
    }
    button[type="submit"]{
      width: 100%;
      padding: 14px;
      background: #28a745;
      color: white;
      border: none;
      border-radius: 6px;
      font-size: 16px;
      cursor: pointer;
    }
    button[type="submit"]:hover{ background:#218838; }

    /* ===== People stepper ===== */
    .stepper{
      display:flex;
      align-items:center;
      gap:10px;
      margin-top:6px;
      margin-bottom:14px;
    }
    .stepper-btn{
      width:44px;
      height:44px;
      border-radius:10px;
      border:1px solid #ccc;
      background:#fff;
      font-size:22px;
      font-weight:800;
      cursor:pointer;
    }
    .stepper-btn:active{ transform: scale(0.98); }
    .stepper-value{
      flex:1;
      height:44px;
      border:1px solid #ccc;
      border-radius:10px;
      display:flex;
      align-items:center;
      justify-content:center;
      font-weight:800;
      background:#fff;
    }

    /* ===== Needs chips ===== */
    .chips{
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      margin-top:6px;
      margin-bottom:14px;
    }
    .chip{
      border:1px solid #ccc;
      border-radius:999px;
      padding:10px 12px;
      background:#fff;
      cursor:pointer;
      user-select:none;
      font-size:14px;
      display:flex;
      align-items:center;
      gap:8px;
    }
    .chip input{
      width:auto;
      margin:0;
    }

    /* ===== Your working budget slider styles ===== */
    .budget-wrap { margin-bottom: 14px; }
    .budget-values {
      display: flex;
      justify-content: center;
      margin: 8px 0 10px;
      font-weight: bold;
      color: #222;
    }
    .range-group {
      position: relative;
      height: 34px;
    }
    .range-group input[type="range"]{
      position: absolute;
      left: 0;
      top: 0;
      margin: 0;
      width: 100%;
      height: 34px;
      background: transparent;
      pointer-events: none;
    }
    .range-group input[type="range"]::-webkit-slider-thumb{
      pointer-events: auto;
    }
    .range-group input[type="range"]::-moz-range-thumb{
      pointer-events: auto;
    }

    /* ===== Demand cards ===== */
    .cards{
      display:grid;
      grid-template-columns: 1fr;
      gap: 10px;
      margin-top: 10px;
    }
    .card{
      border: 1px solid var(--border);
      border-radius: 14px;
      padding: 12px;
      background: #fff;
    }
    .card .meta{
      display:flex;
      justify-content:space-between;
      gap: 8px;
      flex-wrap:wrap;
      color: var(--muted);
      font-size: 12px;
      margin-bottom: 6px;
    }
    .card strong{ font-size: 14px; }
    .pill{
      display:inline-block;
      padding: 6px 10px;
      border-radius: 999px;
      background: #f1f5f9;
      border: 1px solid var(--border);
      font-size: 12px;
      margin: 4px 6px 0 0;
    }

    /* ===== Submit toast popup ===== */
    .toast{
      position: fixed;
      left: 50%;
      bottom: 22px;
      transform: translateX(-50%) translateY(20px);
      background: #111;
      color: #fff;
      padding: 12px 16px;
      border-radius: 12px;
      box-shadow: 0 12px 30px rgba(0,0,0,.25);
      font-weight: 700;
      opacity: 0;
      pointer-events: none;
      transition: opacity .18s ease, transform .18s ease;
      z-index: 9999;
    }
    .toast.show{
      opacity: 1;
      transform: translateX(-50%) translateY(0);
    }

    @media (max-width: 780px){
      .benefits{ grid-template-columns: 1fr; }
      .hero h1{ font-size: 24px; }
    }
  </style>
</head>
  <div class="modal" id="authModal">
    <div class="overlay" onclick="closeModal('authModal')"></div>
    <div class="box">
      <header>
        <h2>Login / Register</h2>
        <button class="close" onclick="closeModal('authModal')">✕</button>
      </header>
  
      <button class="btn primary" onclick="loginWithGoogle()" style="width:100%;margin-bottom:12px;">
        Continue with Google
      </button>
  
      <div style="margin:10px 0;text-align:center;color:#666;">OR</div>
  
      <input type="email" id="authEmail" placeholder="Email">
      <input type="password" id="authPassword" placeholder="Password">
  
      <button class="btn primary" style="width:100%;margin-top:10px;"
        onclick="loginWithEmail(
          document.getElementById('authEmail').value,
          document.getElementById('authPassword').value
        )">
        Login
      </button>
  
      <button class="btn" style="width:100%;margin-top:10px;"
        onclick="registerWithEmail(
          document.getElementById('authEmail').value,
          document.getElementById('authPassword').value
        )">
        Register
      </button>
    </div>
  </div>
<body>
  <!-- Drawer + backdrop -->
  <div class="drawer" id="drawer">
    <h3>Menu</h3>
    <a href="#home" onclick="toggleDrawer(false)">Home</a>
    <a href="#benefits" onclick="toggleDrawer(false)">Benefits</a>
    <a href="javascript:void(0)" onclick="openModal('requestModal'); toggleDrawer(false)">Request Rental</a>
    <a href="javascript:void(0)" onclick="openModal('giveRentModal'); toggleDrawer(false)">Give Rent</a>
  </div>
  <div class="backdrop" id="drawerBackdrop" onclick="toggleDrawer(false)"></div>
  
  <!-- Firebase Auth -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import { 
      getAuth, 
      GoogleAuthProvider, 
      signInWithPopup, 
      createUserWithEmailAndPassword,
      signInWithEmailAndPassword,
      onAuthStateChanged,
      signOut
    } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
  
    const firebaseConfig = {
      apiKey: "AIzaSyCvyIV4XSWzGnMzMhgJBYAPRbf8NB2NYCg",
      authDomain: "find-rental-f7694.firebaseapp.com",
      projectId: "find-rental-f7694",
      storageBucket: "find-rental-f7694.firebasestorage.app",
      messagingSenderId: "6641924981",
      appId: "1:6641924981:web:9dfaf299e16108a97d713c"
    };
  
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const provider = new GoogleAuthProvider();
  
    // Make auth accessible globally
    window.firebaseAuthCurrentUser = () => auth.currentUser;
  
    // Google Login
    window.loginWithGoogle = async function() {
      try {
        await signInWithPopup(auth, provider);
      } catch (err) {
        alert(err.message);
      }
    };
  
    // Email Register
    window.registerWithEmail = async function(email, password) {
      try {
        await createUserWithEmailAndPassword(auth, email, password);
      } catch (err) {
        alert(err.message);
      }
    };
  
    // Email Login
    window.loginWithEmail = async function(email, password) {
      try {
        await signInWithEmailAndPassword(auth, email, password);
      } catch (err) {
        alert(err.message);
      }
    };
  
    // Logout
    window.logoutUser = async function() {
      await signOut(auth);
    };
  
    // Detect login state
    onAuthStateChanged(auth, (user) => {
      if (user) {
        console.log("Logged in:", user.email);
        document.body.classList.add("logged-in");
      } else {
        console.log("Logged out");
        document.body.classList.remove("logged-in");
      }
    });
  </script>

  <!-- Topbar -->
  <div class="topbar" id="home">
    <button class="hamburger" aria-label="menu" onclick="toggleDrawer(true)">
      <span></span>
    </button>

    <div class="logo">
      <div class="logo-badge">FR</div>
      <div>
        cKeys
        <small>Connecting Keys All over Malaysia</small>
      </div>
    </div>
  </div>

  <!-- Main content -->
  <div class="wrap">
    <div class="hero">
      <h1>Where is it?</h1>
      <p>Submit your request — we’ll help you find one. Or if you have a unit, view tenant demand and offer rent.</p>

      <div class="actions">
        <button class="btn primary" onclick="openModal('requestModal')">REQUEST</button>
        <button class="btn" onclick="openModal('giveRentModal')">GIVE RENT</button>
      </div>
    </div>

    <div class="section-title" id="benefits">Benefit</div>

    <div class="benefits">
      <div class="panel">
        <h3>FOR TENANT</h3>
        <ul>
          <li>Submit once — faster search</li>
          <li>Get matched to available landlords</li>
          <li>Filter by location & budget</li>
        </ul>
      </div>

      <div class="panel">
        <h3>FOR LANDLORD</h3>
        <ul>
          <li>See real tenant demand</li>
          <li>Find tenants faster (less vacancy)</li>
          <li>Target the right budget & area</li>
        </ul>
      </div>
    </div>
  </div>

  <!-- ===================== REQUEST MODAL ===================== -->
  <div class="modal" id="requestModal">
    <div class="overlay" onclick="closeModal('requestModal')"></div>
    <div class="box">
      <header>
        <h2>Tenant Request</h2>
        <button class="close" onclick="closeModal('requestModal')">✕</button>
      </header>

      <form id="requestForm">
        <label>Full Name</label>
        <input name="name" required>

        <label>Email</label>
        <input name="email">

        <label>Phone / WhatsApp</label>
        <input name="phone" required>

        <label>Property Type</label>
        <select name="propertyType" required>
          <option value="">Select Property Type</option>
          <option>Room</option>
          <option>Apartment</option>
          <option>House</option>
        </select>

        <label>State</label>
        <select id="state" name="state" required>
          <option value="">Select State</option>
          <option>Johor</option>
          <option>Kedah</option>
          <option>Kelantan</option>
          <option>Melaka</option>
          <option>Negeri Sembilan</option>
          <option>Pahang</option>
          <option>Penang</option>
          <option>Perak</option>
          <option>Perlis</option>
          <option>Sabah</option>
          <option>Sarawak</option>
          <option>Selangor</option>
        </select>

        <label>City / Town</label>
        <select id="city" name="city" required>
          <option value="">Select City</option>
        </select>

        <label>Budget (RM)</label>
        <div class="budget-wrap">
          <div class="budget-values">
            <span id="budgetText">RM 500 – RM 1500</span>
          </div>
          <div class="range-group">
            <input id="minBudget" type="range" min="0" max="5000" step="50" value="500">
            <input id="maxBudget" type="range" min="0" max="5000" step="50" value="1500">
          </div>
          <input type="hidden" name="budget" id="budgetHidden" value="500 - 1500">
        </div>

        <label>Move-in Date</label>
        <input name="moveInDate" type="date">

        <label>Duration</label>
        <select name="duration" required>
          <option value="">Select duration</option>
          <option value="1 Month">1 Month</option>
          <option value="6 Months">6 Months</option>
          <option value="1 Year">1 Year</option>
          <option value="2 Years">2 Years</option>
          <option value="3 Years">3 Years</option>
          <option value="As Long As Possible">As Long As Possible</option>
        </select>

        <label>Occupation</label>
        <!-- NOTE: this select has NO name to avoid duplicate fields -->
        <select id="occupationSelect" required>
          <option value="">Select occupation</option>
          <option value="Student">Student</option>
          <option value="Worker">Worker</option>
          <option value="Business Owner">Business Owner</option>
          <option value="Freelancer">Freelancer</option>
          <option value="Government">Government</option>
          <option value="Other">Other</option>
        </select>

        <div id="occupationOtherWrap" style="display:none;">
          <label>Please specify</label>
          <input id="occupationOtherInput" type="text" placeholder="Type your occupation">
        </div>

        <!-- This is the only occupation field that gets submitted -->
        <input type="hidden" name="occupation" id="occupationHidden" value="">

        <label>Number of People</label>
        <div class="stepper">
          <button type="button" class="stepper-btn" id="peopleMinus">−</button>
          <div class="stepper-value" id="peopleValue">1</div>
          <button type="button" class="stepper-btn" id="peoplePlus">+</button>
        </div>
        <input type="hidden" name="people" id="peopleHidden" value="1">

        <label>Extra Needs</label>
        <div class="chips" id="needsChips">
          <label class="chip"><input type="checkbox" value="Washing machine"> Washing machine</label>
          <label class="chip"><input type="checkbox" value="Parking"> Parking</label>
          <label class="chip"><input type="checkbox" value="Furnished"> Furnished</label>
          <label class="chip"><input type="checkbox" value="Wifi"> Wifi</label>
          <label class="chip"><input type="checkbox" value="Air-cond"> Air-cond</label>
          <label class="chip"><input type="checkbox" value="Near MRT/LRT"> Near MRT/LRT</label>
        </div>
        <input type="hidden" name="needs" id="needsHidden" value="">

        <button type="submit">Submit Request</button>
      </form>
    </div>
  </div>

  <!-- ===================== GIVE RENT MODAL (LIVE from Google Sheet) ===================== -->
  <div class="modal" id="giveRentModal">
    <div class="overlay" onclick="closeModal('giveRentModal')"></div>
    <div class="box">
      <header>
        <h2>Tenant Demand</h2>
        <button class="close" onclick="closeModal('giveRentModal')">✕</button>
      </header>

      <p style="margin:0;color:#666;line-height:1.4;">
        Live tenant requests .
      </p>

      <div class="cards" id="demandCards"></div>
    </div>
  </div>

  <!-- Toast popup -->
  <div class="toast" id="submitToast">✅ Request submitted successfully!</div>

  <script>
    /* ===== Drawer ===== */
    const drawer = document.getElementById("drawer");
    const drawerBackdrop = document.getElementById("drawerBackdrop");
    function toggleDrawer(open){
      drawer.classList.toggle("open", !!open);
      drawerBackdrop.classList.toggle("show", !!open);
    }

    /* ===== Modals ===== */
    function openModal(id){
      document.getElementById(id).classList.add("show");
      document.body.style.overflow = "hidden";

      if (id === "giveRentModal") {
        loadDemandCards(30);
      }
    }

    function closeModal(id){
      document.getElementById(id).classList.remove("show");
      document.body.style.overflow = "";
    }

    /* ===== Toast ===== */
    const submitToast = document.getElementById("submitToast");
    let toastTimer = null;
    function showToast(msg){
      submitToast.textContent = msg;
      submitToast.classList.add("show");
      clearTimeout(toastTimer);
      toastTimer = setTimeout(() => submitToast.classList.remove("show"), 2200);
    }

    /* ===== City options ===== */
    const cityOptions = {
      "Johor": ["Kluang", "Kulai", "Tangkak", "Masai", "Parit Jawa", "Batu Pahat", "Ulu Tiram", "Mersing", "Johor Baharu", "Kota Tinggi"],
      "Kedah": ["Alor Setar", "Langkawi", "Sungai Petan", "Baling", "Changloon", "Kodiang", "Jitra", "Kulim", "Pendang", "Serdang"],
      "Kelantan": ["Kota Bharu", "Dabong", "Jelawat", "Ketereh", "Kuala Krai", "Kubang Kerian", "Machang", "Pasir Mas", "Pengkalan Chepa", "Pengkalan Kubor", "Pengkalan Pasir", "Perupok", "Wakaf Bharu", "Wakaf Che Yeh"],
      "Melaka": ["Ayer Keroh", "Alor Gajah", "Asahan", "Ayer Paabas", "Batu Berendam", "Bemban", "Jasin", "Klebang", "Lendu, Alor Gajah", "Lubuk China", "Machap Baru", "Paya Rumput", "Pokok Mangga", "Simpang Ampat", "Telok Gong", "Telok Mas"],
      "Negeri Sembilan": ["Air Kuning Selatan", "Ampang Tinggi", "Bahau", "Bandar Baru Nilai", "Bandar Seri Jempol", "Batang Benar", "Batu Kikir", "Gemas", "Kota", "Kuala Pilah", "Kuala Sawah", "Lukut", "Mambau", "Nilai", "Pajam", "Pasir Panjang", "Pengkalan Kempas", "Port Dickson", "Rembau", "Rompin", "Senawang", "Seremban 2", "Seremban 3", "Seri Menanti", "Serting", "Sikamat", "Siliau", "Simpang Durian", "Simpang Pertang", "Sungai Gadut", "Sungai Muntoh", "Tampin", "Tanjung Ipoh", "Teluk Kemang", "Tiroi"],
      "Pahang": ["Bandar Bera", "Bandar Muadzam Shah", "Bandar Tun Razak", "Bentong", "Gambang", "Gebeng", "Genting Highlands", "Jerantut", "Karak", "Kuantan", "Mentakab", "Pekan", "Raub", "Tanah Rata", "Temerloh"],
      "Penang": ["Bukit Mertajam", "Balik Pulau", "Batu Kawan", "Bayan Lepas", "Butterworth", "Kepala Batas", "Nibong Tebal", "Perai", "Permatang Pauh", "Simpang Ampat", "Tasek Gelugor"],
      "Perak": ["Sungai Siput", "Ipoh", "Taiping", "Gopeng", "Gerik", "Chemor", "Lumut", "Kuala Kangsar", "Tanjong Malim"],
      "Perlis": ["Kangar", "Padang Besar", "Kaki Bukit", "Kuala Perlis"],
      "Sabah": ["Ranau", "Kota Kinabalu", "Sandakan", "Tamparuli", "Tuaran", "Penampang", "Lahad Datu", "Semporna", "Tawau", "Kota Belud"],
      "Sarawak": ["Miri", "Kuching", "Niah", "Bau", "Bintulu", "Kota Samarahan", "Sibu", "Limbang", "Lundu"],
      "Selangor": ["Petaling Jaya", "Shah Alam", "Ampang", "Rawang", "Gombak", "Semenyih", "Hulu Langat", "Ampang Jaya", "Seri Kembangan", "Kuala Kubu Bharu"],
    };

    document.getElementById("state").addEventListener("change", function() {
      const state = this.value;
      const citySelect = document.getElementById("city");
      citySelect.innerHTML = "<option value=''>Select City</option>";

      if (cityOptions[state]) {
        cityOptions[state].forEach(city => {
          const option = document.createElement("option");
          option.value = city;
          option.textContent = city;
          citySelect.appendChild(option);
        });
      }
    });

    /* ===== Budget slider ===== */
    const minSlider = document.getElementById("minBudget");
    const maxSlider = document.getElementById("maxBudget");
    const budgetText = document.getElementById("budgetText");
    const budgetHidden = document.getElementById("budgetHidden");

    function formatRM(n) {
      return "RM " + Number(n).toLocaleString("en-MY");
    }

    function syncBudget() {
      let minVal = Number(minSlider.value);
      let maxVal = Number(maxSlider.value);

      if (minVal > maxVal) {
        [minVal, maxVal] = [maxVal, minVal];
      }

      budgetText.textContent = `${formatRM(minVal)} – ${formatRM(maxVal)}`;
      budgetHidden.value = `${minVal} - ${maxVal}`;
    }

    minSlider.addEventListener("input", syncBudget);
    maxSlider.addEventListener("input", syncBudget);
    syncBudget();

    /* ===== People stepper ===== */
    const peopleMinus = document.getElementById("peopleMinus");
    const peoplePlus  = document.getElementById("peoplePlus");
    const peopleValue = document.getElementById("peopleValue");
    const peopleHidden = document.getElementById("peopleHidden");

    let peopleCount = 1;

    function syncPeople(){
      peopleValue.textContent = String(peopleCount);
      peopleHidden.value = String(peopleCount);
    }

    peopleMinus.addEventListener("click", () => {
      peopleCount = Math.max(1, peopleCount - 1);
      syncPeople();
    });

    peoplePlus.addEventListener("click", () => {
      peopleCount = Math.min(20, peopleCount + 1);
      syncPeople();
    });

    syncPeople();

    /* ===== Needs chips → hidden field ===== */
    const needsHidden = document.getElementById("needsHidden");
    const needsChips = document.getElementById("needsChips");

    function syncNeeds(){
      const selected = [...needsChips.querySelectorAll("input[type='checkbox']:checked")]
        .map(x => x.value);
      needsHidden.value = selected.join(", ");
    }

    needsChips.addEventListener("change", syncNeeds);
    syncNeeds();

    /* ===== Occupation Other logic ===== */
    const occupationSelect = document.getElementById("occupationSelect");
    const occupationOtherWrap = document.getElementById("occupationOtherWrap");
    const occupationOtherInput = document.getElementById("occupationOtherInput");
    const occupationHidden = document.getElementById("occupationHidden");

    function syncOccupation(){
      const val = occupationSelect.value;
      if (val === "Other") {
        occupationOtherWrap.style.display = "block";
        occupationHidden.value = (occupationOtherInput.value || "").trim();
      } else {
        occupationOtherWrap.style.display = "none";
        occupationHidden.value = val;
      }
    }

    occupationSelect.addEventListener("change", () => {
      syncOccupation();
      if (occupationSelect.value === "Other") occupationOtherInput.focus();
    });
    occupationOtherInput.addEventListener("input", syncOccupation);
    syncOccupation();

    /* ===== Submit form ===== */
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwTVjVrVwALfO9RaxR--LxD1XymlLfsP-LSNiMq9o3rhaz5wxbd5ciD9fWzhYMqO9y6/exec";

    document.getElementById("requestForm").addEventListener("submit", function(e) {
      e.preventDefault();

      const form = this;

      // make sure hidden occupation is correct before submit
      syncOccupation();

      // enforce: if Other selected, require text
      if (occupationSelect.value === "Other" && !occupationHidden.value.trim()) {
        showToast("Please type your occupation.");
        occupationOtherInput.focus();
        return;
      }

      const data = Object.fromEntries(new FormData(form).entries());

      fetch(SCRIPT_URL, {
        method: "POST",
        body: JSON.stringify(data)
      })
      .then(res => res.text())
      .then(() => {
        showToast("✅ Request submitted successfully!");

        form.reset();

        // reset occupation
        occupationOtherWrap.style.display = "none";
        occupationOtherInput.value = "";
        syncOccupation();

        // reset people + needs
        peopleCount = 1;
        syncPeople();
        [...needsChips.querySelectorAll("input[type='checkbox']")].forEach(cb => cb.checked = false);
        syncNeeds();

        // reset budget slider
        minSlider.value = 500;
        maxSlider.value = 1500;
        syncBudget();

        // close modal after submit
        closeModal("requestModal");
      })
      .catch(() => alert("Submission failed. Please try again."));
    });
    
    function requireAuth(callback) {
      const user = window.firebaseAuthCurrentUser();
      if (!user) {
        openModal("authModal");
        return;
      }
      callback();
    }

    /* ===== Load Tenant Demand from Google Sheet (JSONP) ===== */
    function loadDemandCards(limit = 30) {
      const el = document.getElementById("demandCards");
      el.innerHTML = "Loading...";
    
      const cbName = "demandCb_" + Date.now();
    
      window[cbName] = function(payload) {
        try {
          if (!payload || !payload.ok) {
            el.innerHTML = "Failed to load data.";
            return;
          }
    
          const rows = payload.rows || [];
          if (rows.length === 0) {
            el.innerHTML = "No requests yet.";
            return;
          }
    
          el.innerHTML = "";
    
          rows.forEach((d) => {
            const needsArr = (d.needs || "").split(",").map(s => s.trim()).filter(Boolean);
    
            let moveInNice = "-";
            if (d.moveInDate) {
              const dt = new Date(d.moveInDate);
              moveInNice = isNaN(dt.getTime()) ? String(d.moveInDate) : dt.toLocaleDateString("en-MY");
            }
    
            const offered = String(d.status || "").toLowerCase() === "offered";
    
            const div = document.createElement("div");
            div.className = "card";
            div.innerHTML = `
              <div class="meta">
                <span>${d.state || "-"} • ${d.city || "-"}</span>
                <span>${d.propertyType || "-"}</span>
              </div>
    
              <strong>Budget: RM ${d.budget || "-"}</strong>
    
              <div style="margin-top:6px;color:#444;font-size:13px;">
                Move-in: ${moveInNice} • People: ${d.people || "-"}
              </div>
    
              <div style="margin-top:6px;color:#444;font-size:13px;">
                Duration: ${d.duration || "-"} • Occupation: ${d.occupation || "-"}
              </div>
    
              <div style="margin-top:8px;">
                ${needsArr.map(n => `<span class="pill">${n}</span>`).join("")}
                ${d.status ? `<span class="pill">Status: ${d.status}</span>` : ""}
              </div>
    
              <div class="card-actions">
                <button class="btn primary small ${offered ? "disabled" : ""}" ${offered ? "disabled" : ""} data-requestid="${d.requestId}">
                  ${offered ? "Already Offered" : "Offer Rent"}
                </button>
              </div>
            `;
    
            // attach click handler
            const offerBtn = div.querySelector("button[data-requestid]");
            offerBtn.addEventListener("click", () => {
              const requestId = offerBtn.getAttribute("data-requestid");
              requireAuth(() => offerRent(requestId, offerBtn));
            });
    
            el.appendChild(div);
          });
    
        } finally {
          delete window[cbName];
        }
      };
    
      const url = `${SCRIPT_URL}?action=list&limit=${encodeURIComponent(limit)}&callback=${encodeURIComponent(cbName)}&_ts=${Date.now()}`;
    
      // cleanup old jsonp scripts
      document.querySelectorAll("script[data-jsonp='demand']").forEach(s => s.remove());
    
      const script = document.createElement("script");
      script.dataset.jsonp = "demand";
      script.src = url;
    
      script.onerror = () => {
        el.innerHTML = `Failed to load. Check Apps Script deployment access.<br><small style="color:#666;word-break:break-all;">${url}</small>`;
        delete window[cbName];
      };
    
      document.body.appendChild(script);
      script.onload = () => script.remove();
    }

      };

      const script = document.createElement("script");
      script.src = `${SCRIPT_URL}?action=list&limit=${limit}&callback=${cbName}`;
      script.onerror = () => {
        el.innerHTML = "Failed to load. Check Apps Script deployment access.";
        delete window[cbName];
      };
    
      async function offerRent(requestId, buttonEl) {
        try {
          const user = window.firebaseAuthCurrentUser?.() || null;
      
          // fallback: if your auth modal code doesn't expose helper, we still proceed via Firebase global
          // We'll access Firebase user through a shared getter you add below (D)
      
          if (!user) {
            showToast("Please login first.");
            openModal("authModal");
            return;
          }
      
          // UI loading
          if (buttonEl) {
            buttonEl.textContent = "Offering...";
            buttonEl.classList.add("disabled");
            buttonEl.disabled = true;
          }
      
          const payload = {
            action: "createDeal",
            requestId: String(requestId),
            ownerUid: user.uid,
            ownerEmail: user.email
          };
      
          const res = await fetch(SCRIPT_URL, {
            method: "POST",
            body: JSON.stringify(payload)
          });
      
          const outText = await res.text();
          let out;
          try { out = JSON.parse(outText); } catch(e){ out = null; }
      
          if (!out || !out.ok) {
            throw new Error(out?.error || "Failed to create deal.");
          }
      
          showToast("✅ Offer sent! Deal created: " + out.dealId);
      
          // update UI
          if (buttonEl) {
            buttonEl.textContent = "Already Offered";
            // status pill update (simple refresh)
            setTimeout(() => loadDemandCards(30), 500);
          }
        } catch (err) {
          console.error(err);
          showToast("❌ Offer failed. " + (err?.message || ""));
          if (buttonEl) {
            buttonEl.textContent = "Offer Rent";
            buttonEl.classList.remove("disabled");
            buttonEl.disabled = false;
          }
        }
      }

      document.body.appendChild(script);
      script.onload = () => script.remove();
    }
  </script>
</body>
</html>
